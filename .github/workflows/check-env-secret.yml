name: Check Missing Environment Variables in GitHub Secrets

on:
  push:
    branches:
      - master

jobs:
  check-env-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Extract Environment Variables from Code
        id: extract_vars
        run: |
          # Extract env variables from your code
          grep -rohE '\bprocess\.env\.[A-Za-z_][A-Za-z0-9_]*' . | sed 's/process.env.//' | sort -u > env_variables.txt
          echo "Extracted environment variables:"
          cat env_variables.txt
          echo "::set-output name=env_vars::$(cat env_variables.txt | tr '\n' ' ')"

      - name: Get GitHub Secrets
        id: get_secrets
        run: |
          echo "GitHub repository secrets:"
          echo "${{ toJson(secrets) }}" | jq 'keys' > github_secrets.txt
          cat github_secrets.txt
          echo "::set-output name=secrets::$(cat github_secrets.txt | tr -d '[]" ,\n')"

      - name: Compare Environment Variables and Secrets
        run: |
          echo "Checking for missing environment variables..."
          missing_vars=()
          for var in $(cat env_variables.txt); do
            if ! grep -q "\"$var\"" github_secrets.txt; then
              missing_vars+=("$var")
            fi
          done
          
          if [ ${#missing_vars[@]} -ne 0 ]; then
            echo "❌ Missing environment variables in GitHub Secrets:"
            printf '%s\n' "${missing_vars[@]}"
            exit 1  # Fail the workflow if secrets are missing
          else
            echo "✅ All environment variables are present in GitHub Secrets. Good job, engineers! 🎉"
          fi
