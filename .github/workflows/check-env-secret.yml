#!/bin/bash
# sync-secrets.sh - Universal GitHub Secret Synchronization

set -eo pipefail
  
  # Configuration
REPO_OWNER=$(gh repo view --json owner -q '.owner.login')
REPO_NAME=$(gh repo view --json name -q '.name')
TEMP_DIR=".gh_secrets_temp"
  
  # Create temp directory
mkdir -p "$TEMP_DIR"
trap 'rm -rf "$TEMP_DIR"' EXIT

echo "üîç Scanning repository for environment variables..."
  
  # Detect all environment variable patterns
find . -type f \( \
-name "*.js" -o \
-name "*.ts" -o \
-name "*.java" -o \
-name "*.kt" -o \
-name "*.py" -o \
-name "*.go" -o \
-name "*.rs" -o \
-name "*.php" -o \
-name "*.properties" -o \
-name "*.yml" -o \
-name "*.yaml" -o \
-name ".env*" \
\) ! -path "./node_modules/*" ! -path "./.git/*" -exec grep -Eho \
'process\.env\.[A-Z0-9_]+|\$\{[A-Z0-9_]+\}|@Value\("\\$\\{[A-Z0-9_]+\\}"|env\.[A-Z0-9_]+|os\.getenv\(["'"'"'][A-Z0-9_]+' {} + | \
grep -oE '[A-Z0-9_]+' | \
sort -u > "$TEMP_DIR/code_vars.txt"
  
  # Get .env file variables
grep -vh '^#' .env* 2>/dev/null | grep -v '^$' | cut -d '=' -f1 >> "$TEMP_DIR/code_vars.txt"
sort -u "$TEMP_DIR/code_vars.txt" -o "$TEMP_DIR/code_vars.txt"

echo "Found $(wc -l < "$TEMP_DIR/code_vars.txt") unique variables in code"
  
  # Get current GitHub secrets
echo "üîê Fetching existing secrets..."
gh secret list --json name -q '.[].name' | sort > "$TEMP_DIR/gh_secrets.txt"
  
  # Find missing secrets
comm -23 "$TEMP_DIR/code_vars.txt" "$TEMP_DIR/gh_secrets.txt" > "$TEMP_DIR/missing.txt"

if [ ! -s "$TEMP_DIR/missing.txt" ]; then
echo "‚úÖ All environment variables are properly secured"
exit 0
fi

echo "‚ö†Ô∏è  Missing $(wc -l < "$TEMP_DIR/missing.txt") secrets:"
cat "$TEMP_DIR/missing.txt"
  
  # Add missing secrets
while read -r var; do
echo "üõ† Processing $var..."
  
  # Try to get value from .env files
value=$(grep -m1 "^$var=" .env* 2>/dev/null | cut -d '=' -f2- || true)
  
  # Generate secure placeholder if not found
if [ -z "$value" ]; then
value="PLACEHOLDER_$(openssl rand -hex 6)"
echo "‚ÑπÔ∏è  Using generated placeholder for $var"
fi
  
  # Add to GitHub Secrets
if ! gh secret set "$var" --body "$value"; then
echo "‚ùå Failed to add $var"
exit 1
fi
echo "‚úÖ Added $var to GitHub Secrets"
done < "$TEMP_DIR/missing.txt"

echo "üéâ Secret synchronization complete!"
echo "‚ö†Ô∏è  Remember to update placeholder values in GitHub Secrets!"