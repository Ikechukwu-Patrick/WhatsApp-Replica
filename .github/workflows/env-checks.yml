name: Environment Variable Checks

on:
  workflow_call  # Allows other workflows (like CI/CD Pipeline) to call this

jobs:
  check-env-vars:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch last commit for comparison

      - name: Scan for newly added exposed environment variables
        run: |
          FILE="src/main/resources/application.yml"  # Adjust if needed

          if [ ! -f "$FILE" ]; then
            echo "❌ application.yml not found. Skipping check."
            exit 0
          fi

          # Get newly added lines with potential environment variables
          NEW_VARS=$(git diff HEAD^ -- "$FILE" | grep -E "^\+\s*[a-zA-Z0-9_]+:\s*.*" | grep -vE "(ENC\(|\${.*})")

          if [[ -n "$NEW_VARS" ]]; then
            echo "❌ WARNING: Found exposed environment variables in application.yml:"
            echo "$NEW_VARS"
            echo "❌ Ensure all sensitive values use placeholders (\${VAR_NAME}) or encryption (ENC(...))."
            exit 1  # Fail the job
          else
            echo "✅ No exposed environment variables detected."
          fi
