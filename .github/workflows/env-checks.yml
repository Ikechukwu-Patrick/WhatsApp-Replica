name: Environment Variable Checks

on:
  workflow_call

jobs:
  check-env-vars:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history to ensure `git diff` works correctly

      - name: Scan for hardcoded environment variables
        run: |
          FILE="whatsappclone/src/main/resources/application.yml"  # Adjust if needed

          if [ ! -f "$FILE" ]; then
            echo "❌ application.yml not found. Failing the job."
            exit 1
          fi

          # Detect hardcoded sensitive values (e.g., passwords, secrets, API keys)
          SENSITIVE_KEYS="password|secret|api[_-]?key|jwt[_-]?secret|token|access[_-]?key|private[_-]?key|client[_-]?id|client[_-]?secret|aws[_-]?secret|db[_-]?password"
          HARCODED_VALUES=$(grep -E "^\s*($SENSITIVE_KEYS):\s*[^$\{]" "$FILE" || true)

          # Detect hardcoded values for any key (not just sensitive keys)
          HARCODED_ANY=$(grep -E "^\s*[a-zA-Z0-9_\-]+:\s*[^$\{]" "$FILE" | grep -vE "^\s*($SENSITIVE_KEYS):\s*[^$\{]" || true)

          if [[ -n "$HARCODED_VALUES" || -n "$HARCODED_ANY" ]]; then
            echo "❌ WARNING: Hardcoded values detected in application.yml:"
            [[ -n "$HARCODED_VALUES" ]] && echo "❌ Hardcoded sensitive values found:" && echo "$HARCODED_VALUES"
            [[ -n "$HARCODED_ANY" ]] && echo "❌ Hardcoded values found for other keys:" && echo "$HARCODED_ANY"
            echo "❌ Please use environment variables or secure secrets management!"
            exit 1  # Fail the job
          fi

          echo "✅ No hardcoded values detected."