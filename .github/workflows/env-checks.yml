name: Environment Variable Checks

on:
  workflow_call

jobs:
  check-env-vars:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensure full history is available

      - name: Debug Repository Structure
        run: |
          echo "üîç Debugging repository structure..."
          ls -R

      - name: Locate application.yml
        run: |
          # Dynamically find application.yml
          FILE=$(find . -type f -name "application.yml" | grep "src/main/resources" | head -n 1)

          if [ -z "$FILE" ]; then
            echo "‚ùå application.yml not found. Failing the job."
            exit 1
          fi

          echo "‚úÖ Found application.yml at: $FILE"
          echo "FILE_PATH=$FILE" >> $GITHUB_ENV

      - name: Scan for Hardcoded Environment Variables
        run: |
          FILE=$FILE_PATH  # Get the correct path from the previous step

          echo "üîç Checking for hardcoded values in $FILE..."

          # Get changes specific to application.yml
          NEW_VARS=$(git diff --unified=0 origin/master...HEAD -- "$FILE" | grep -E "^\+\s*[a-zA-Z0-9_\-]+:\s*.*" || true)

          if [ -z "$NEW_VARS" ]; then
            echo "‚úÖ No new changes detected in application.yml."
            exit 0
          fi

          # Define sensitive keys that should NEVER be hardcoded
          SENSITIVE_KEYS="password|secret|api[_-]?key|jwt[_-]?secret|token|access[_-]?key|private[_-]?key|client[_-]?id|client[_-]?secret|aws[_-]?secret|db[_-]?password"

          # Filter out only true hardcoded values (ignore placeholders like ${VAR_NAME})
          HARDCODED_VALUES=$(echo "$NEW_VARS" | grep -iE "^\+\s*($SENSITIVE_KEYS):\s*(\".*\"|'.*'|[^$\{\"]+)" || true)

          # Detect environment variables with hardcoded default values (${VAR_NAME=default_value})
          EXPOSED_DEFAULTS=$(echo "$NEW_VARS" | grep -E "\$\{[A-Za-z0-9_]+=[^}]+\}" || true)

          # Detect non-sensitive values that are hardcoded (but ignore placeholders like ${VAR_NAME})
          HARDCODED_NON_SENSITIVE=$(echo "$NEW_VARS" | grep -E "^\+\s*[a-zA-Z0-9_\-]+:\s*(\".*\"|'.*'|[^$\{\s]+)" | grep -vE "^\+\s*($SENSITIVE_KEYS):" || true)

          # Ensure ONLY application.yml is checked, preventing GitHub Actions YAML keys from being flagged
          if [[ -n "$HARDCODED_VALUES" || -n "$EXPOSED_DEFAULTS" || -n "$HARDCODED_NON_SENSITIVE" ]]; then
            echo "‚ùå WARNING: Hardcoded values detected in application.yml:"
            [[ -n "$HARDCODED_VALUES" ]] && echo "‚ùå Hardcoded sensitive values found:" && echo "$HARDCODED_VALUES"
            [[ -n "$EXPOSED_DEFAULTS" ]] && echo "‚ùå Hardcoded defaults in placeholders found:" && echo "$EXPOSED_DEFAULTS"
            [[ -n "$HARDCODED_NON_SENSITIVE" ]] && echo "‚ùå Hardcoded values found for other keys:" && echo "$HARDCODED_NON_SENSITIVE"
            echo "‚ùå Please use environment variables or secure secrets management!"
            exit 1  # Fail the job
          fi

          echo "‚úÖ No hardcoded values detected."
