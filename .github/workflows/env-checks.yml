name: Environment Variable Checks

on:
  workflow_call

jobs:
  check-env-vars:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensure full history is available

      - name: Locate application.yml
        run: |
          FILE=$(find . -type f -name "application.yml" | grep "src/main/resources" | head -n 1)

          if [ -z "$FILE" ]; then
            echo "‚ùå application.yml not found. Failing the job."
            exit 1
          fi

          echo "‚úÖ Found application.yml at: $FILE"
          echo "FILE_PATH=$FILE" >> $GITHUB_ENV

      - name: Scan for Hardcoded Environment Variables
        run: |
          FILE=$FILE_PATH  # Get correct path

          echo "üîç Checking for hardcoded values in $FILE..."

          # Get new changes from application.yml
          NEW_VARS=$(git diff --unified=0 origin/master...HEAD -- "$FILE" | grep -E "^\+\s*[a-zA-Z0-9_\-]+:\s*.*" || true)

          if [ -z "$NEW_VARS" ]; then
            echo "‚úÖ No new changes detected in application.yml."
            exit 0
          fi

          # Define sensitive keys that should NEVER be hardcoded
          SENSITIVE_KEYS="password|secret|api[_-]?key|jwt[_-]?secret|token|access[_-]?key|private[_-]?key|client[_-]?id|client[_-]?secret|aws[_-]?secret|db[_-]?password"

          # Flag real hardcoded sensitive values (ignore placeholders like ${VAR_NAME})
          HARDCODED_VALUES=$(echo "$NEW_VARS" | grep -iE "^\+\s*($SENSITIVE_KEYS):\s*(?!\$\{)[^\s]+" || true)

          # Flag default values inside placeholders (e.g., ${VAR_NAME=default_value} or ${VAR_NAME:default_value})
          EXPOSED_DEFAULTS=$(echo "$NEW_VARS" | grep -E "\$\{[A-Za-z0-9_]+[:=][^}]+\}" || true)

          # Detect non-sensitive values that are hardcoded (ignore placeholders like ${VAR_NAME})
          HARDCODED_NON_SENSITIVE=$(echo "$NEW_VARS" | grep -E "^\+\s*[a-zA-Z0-9_\-]+:\s*(?!\$\{)[^\s]+" | grep -vE "^\+\s*($SENSITIVE_KEYS):" || true)

          # Fail if any hardcoded values exist
          if [[ -n "$HARDCODED_VALUES" || -n "$EXPOSED_DEFAULTS" || -n "$HARDCODED_NON_SENSITIVE" ]]; then
            echo "‚ùå WARNING: Hardcoded values detected in application.yml:"
            [[ -n "$HARDCODED_VALUES" ]] && echo "‚ùå Hardcoded sensitive values found:" && echo "$HARDCODED_VALUES"
            [[ -n "$EXPOSED_DEFAULTS" ]] && echo "‚ùå Hardc
