name: Enhanced Spring Boot CI/CD

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  secret-management:
    name: Secret Synchronization
    runs-on: ubuntu-latest
    outputs:
      build_approved: ${{ steps.validate-secrets.outputs.ready }}
      missing_vars: ${{ steps.validate-secrets.outputs.missing_vars }}
    steps:
      - uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt-get remove -y gh || true
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install -y gh

      - name: Authenticate GitHub CLI
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "$GH_PAT" | gh auth login --with-token
          gh auth status

      - name: Scan Spring Boot Properties
        id: scan-props
        run: |
          echo "üîç Scanning for environment variables..."
          
          find whatsappclone/src -type f \( \
            -name "*.java" -o \
            -name "*.properties" -o \
            -name "*.yml" -o \
            -name "*.yaml" \
          \) -exec grep -Eho '\$\{[A-Z0-9_]+\}|@Value\("\\$\\{[A-Z0-9_]+\\}"' {} + | \
            grep -oE '[A-Z0-9_]+' | \
            sort -u | jq -R -s -c 'split("\n") | map(select(. != ""))' > env_vars.json
          
          echo "üìÇ Extracted environment variables:"
          cat env_vars.json
          
          echo "env_vars=$(cat env_vars.json)" >> $GITHUB_OUTPUT

      - name: Validate Secrets
        id: validate-secrets
        run: |
          echo "üîé Validating secrets..."
          
          cat env_vars.json  # Debugging step: Check extracted JSON
          jq . env_vars.json  # Validate JSON structure
          
          # Extract environment variable names
          jq -r '.[]' env_vars.json > env_vars.txt
          
          # Fetch existing GitHub secrets
          gh secret list --json name | jq -r '.[].name' > secrets.txt
          
          # Find missing secrets
          grep -vxFf secrets.txt env_vars.txt > missing.txt || true
          missing_count=$(wc -l < missing.txt | tr -d ' ')
          
          if [ "$missing_count" -gt 0 ]; then
            echo "‚ö†Ô∏è Missing secrets found: $missing_count"
            cat missing.txt
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "missing_vars=$(tr '\n' ',' < missing.txt | sed 's/,$//')" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ All secrets are present."
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "missing_vars=none" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack
        if: steps.validate-secrets.outputs.ready == 'false'
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "‚ö†Ô∏è New Secrets Added to ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Action Required:* Update these placeholder secrets:"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "`${{ steps.validate-secrets.outputs.missing_vars }}`"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Update Secrets"
                      },
                      "url": "https://github.com/${{ github.repository }}/settings/secrets/actions"
                    }
                  ]
                }
              ]
            }

  build-and-deploy:
    name: Build & Deploy
    needs: secret-management
    if: needs.secret-management.outputs.build_approved == 'true'
    runs-on: ubuntu-latest
    env:
      SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
      SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
      SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2
            whatsappclone/target
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

      - name: Build with Maven
        working-directory: whatsappclone
        run: mvn clean package -DskipTests

      - name: Verify JAR
        run: |
          java -jar whatsappclone/target/*.jar --spring.profiles.active=ci &
          APP_PID=$!
          timeout 60 bash -c 'while ! curl -s http://localhost:8080/actuator/health | grep -q '"'"'"status":"UP"'"'"'; do sleep 2; done' || \
            { echo "::error::Application failed to start"; kill $APP_PID; exit 1; }
          curl -s http://localhost:8080/actuator/health | jq .
          kill $APP_PID
