name: CI/CD Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  env-check:
    name: Check for Missing Environment Variables in GitHub Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch the last 2 commits for debugging

      - name: Extract Environment Variables from Code
        id: extract_vars
        run: |
          # Extract env variables from your code (Node.js style)
          grep -rohE '\bprocess\.env\.[A-Za-z_][A-Za-z0-9_]*' . | sed 's/process.env.//' | sort -u > env_variables.txt
          
          echo "Extracted environment variables:"
          cat env_variables.txt
          echo "::set-output name=env_vars::$(cat env_variables.txt | tr '\n' ' ')"

      - name: Get GitHub Secrets
        id: get_secrets
        run: |
          echo "GitHub repository secrets:"
          echo "${{ toJson(secrets) }}" | jq 'keys' > github_secrets.txt
          cat github_secrets.txt
          echo "::set-output name=secrets::$(cat github_secrets.txt | tr -d '[]" ,\n')"

      - name: Compare Environment Variables and Secrets
        run: |
          echo "Checking for missing environment variables..."
          missing_vars=()
          for var in $(cat env_variables.txt); do
            if ! grep -q "\"$var\"" github_secrets.txt; then
              missing_vars+=("$var")
            fi
          done
          
          if [ ${#missing_vars[@]} -ne 0 ]; then
            echo "‚ùå Missing environment variables in GitHub Secrets:"
            printf '%s\n' "${missing_vars[@]}"
            exit 1  # Fail the workflow if secrets are missing
          else
            echo "‚úÖ All environment variables are present in GitHub Secrets."
          fi

  build:
    name: Build Application
    needs: env-check  # üëà Run only if env-check passes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history for debugging or other steps

      - name: Set Up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        working-directory: whatsappclone  # Set the correct directory
        run: mvn clean package -DskipTests  # Skip tests during build
